# Курсовая работа по курсу HighLoad
## 1. Тема: Онлайн-кинотеатр
Сервис для поиска, просмотра, рекомендаций и обсуждения фильмов.
## 2. Определение возможного диапазона нагрузок подобного проекта
В качестве примера онлайн-кинотеатра я выбрал [ivi.ru](http://ivi.ru). Месячная аудитория сервиса составляет 50 млн. уникальных пользователей, а общая длительность просмотров в 2019 году составила 1 млрд. часов.
## 3. Планируемая нагрузка
Основная нагрузка для сервиса это стриминг видео-файлов. Клиентами могут быть стационарные компьютеры, смартфоны и тв-приставки. Сервисом будет пользоваться примерно 50 млн. человек в месяц, общая длительность просмотров составит 70 млн. часов, а их суммарное количество 250 млн.
## 4. Логическая схема базы данных
Для проекта онлайн-кинотеатра я выделил несколько основных сущностей: "users", "movies", "serials", "actors" и "reviews". Таблица "movies" содержит в себе данные о фильмах и об отдельных эпизодах сериалов. А в таблице "serials" предоставляет информацию о сериалах в целом, а не об отдельных сериях. Изначально схема базы данных была приведена к нормальной форме Бойса-Кодда, но была денормализована и в некоторые таблицы были внесены избыточные данные. Это сделано для уменьшения количества джойнов с крупными таблицами. Так, например, таблицы "reviews_serial", "reviews_movies" и "reviews_actors" дублируют информацию о пользователях из таблицы "users". В схеме также содержатся таблицы с рекомендациями для авторизованных пользователей на основе ранее просмотренных фильмов и для неавторизованных пользователей.
![alt text](./schema.png)
## 5. Физическая система хранения
Предположим, что выбор фильма для просмотра занимает у пользователя в среднем 5 хитов. На каждый хит на сайте [ivi.ru](http://ivi.ru) приходится порядка 100 запросов. Таким образом

![\Large](https://latex.codecogs.com/svg.latex?\Large&space;rps=\frac{5*100*250,000,000}{30*24*60*60}\approx50000)

Сделаем поправку на то, что ночью трафик падает, а днём и вечером растет. Увеличим среднее RPS в 5 раз. Основная часть запросов это рекомендации по фильмам (пусть это будет 80%).  Таблицы с рекомендациями будут размещаться в базе данных MongoDB на 20 серверах. То есть в среднем на каждую машину будет приходиться по 10000 RPS. Остальные таблицы будут находиться в PostgreSQL на 10 серверах с нагрузкой 5000 RPS.

Определим количество серверов для хранения контента. Основным ограничением здесь является пропускная способность.
Сначала найдём среднее время просмотра фильмов одним пользователями в часах.

![\Large ](https://latex.codecogs.com/svg.latex?\Large&space;t=\frac{70,000,000}{250,000,000}=0.28)

Теперь необходимо вычислить количество пользователей, одновременно использующих сервис в течение среднего времени просмотра

![\Large ](https://latex.codecogs.com/svg.latex?\Large&space;users=\frac{250,000,000*0,28}{30*24}\approx100,000)

Скорость скачивания для качества 1080р составляет 4.5 МБит/с, для 720р - 2.77 МБит/с, для 576р - 1.83 МБит/с, 480р - 1.3 МБит/с, для 360р - 0.79 МБит/с. Тогда средняя скорость - 2.238 МБит/с. Рассчитаем пропускную способность в ГБит/с, которую необходимо обеспечить с учётом поправки на неравномерность трафика.

![\Large ](https://latex.codecogs.com/svg.latex?\Large&space;speed={5*100,000*2.24}\approx1120)

Один сервер может отдавать примерно 40 ГБит/с. Таким образом, для онлайн-просмотра необходимо 28 серверов
## 6. Выбор прочих технологий: языки программирования, фреймворки, протоколы взаимодействия, веб-сервера и т.д.

**Бэкенд**: Языком разработки  я выберу Golang. Этот язык доказал, что отлично подходит для систем с высокой нагрузкой: concurrency из коробки, эффективное использование ресурсов, высокая скорость разработки, обширная стандартная библиотека, популярность языка.

**Фронтенд**: Выбираю самый распространенный стек технологий HTML,CSS, JavaScript.

**Протоколы**: HTTPS - для безопасного соединения клиента и сервера. HTTP внутри датацентра. Protobuf - стандартный протокол для обмена сообщениями между микросервисами в фреймворке gRPC.